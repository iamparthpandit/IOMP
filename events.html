<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Events - IOMP</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<style>
  /* Profile Dropdown Styles */
  .profile-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    width: 350px;
    background: #2d3748;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    color: white;
  }
  
  .profile-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .profile-dropdown-item {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s ease;
    border-radius: 8px;
    margin: 4px 8px;
  }
  
  .profile-dropdown-item:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .profile-dropdown-section {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 8px 0;
  }
  
  .profile-dropdown-header {
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .profile-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 12px;
    object-fit: cover;
  }
</style>
<script>tailwind.config = {theme: {extend: {colors: {"iomp-blue": {dark: "#1e3a8a", light: "#3b82f6"}, "custom-bg": "#f0f2f5", primary: "#135bec"}}}};</script>
</head>
<body class="bg-custom-bg font-sans">
<div class="min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button onclick="window.location.href='/'" class="text-gray-600 hover:text-gray-900">
            <i class="fas fa-arrow-left text-xl"></i>
          </button>
          <img src="/IOMP_LOGO.png" alt="IOMP Logo" class="h-8 w-8">
          <h1 class="text-2xl font-bold text-gray-900">All Events</h1>
        </div>
        <div class="relative">
          <img id="userAvatar" class="h-10 w-10 rounded-full object-cover cursor-pointer hover:opacity-80 transition" src="" alt="User">
          <!-- Profile Dropdown -->
          <div id="profileDropdown" class="profile-dropdown">
            <div class="profile-dropdown-header">
              <img id="dropdownAvatar" class="profile-avatar-large" src="" alt="Profile Picture">
              <h3 id="dropdownName" class="text-lg font-semibold">User Name</h3>
              <p id="dropdownEmail" class="text-sm text-gray-300 mt-1">user@email.com</p>
            </div>
            <div class="profile-dropdown-section">
              <div class="profile-dropdown-item" onclick="window.location.href='/profile'">
                <i class="fas fa-key text-gray-300 text-lg"></i>
                <span>Profile Settings</span>
              </div>
              <div class="profile-dropdown-item" onclick="alert('Account management coming soon')">
                <i class="fab fa-google text-gray-300 text-lg"></i>
                <span>Manage your Account</span>
              </div>
              <div class="profile-dropdown-item" onclick="window.location.href='/profile'">
                <i class="fas fa-edit text-gray-300 text-lg"></i>
                <span>Customise profile</span>
              </div>
              <div class="profile-dropdown-item">
                <i class="fas fa-sync text-green-400 text-lg"></i>
                <span>Sync is on</span>
              </div>
            </div>
            <div class="profile-dropdown-section">
              <p class="text-xs text-gray-400 px-4 py-2 font-semibold">OTHER PROFILES</p>
              <div id="otherProfilesList"></div>
              <div class="profile-dropdown-item" onclick="alert('Add profile feature coming soon')">
                <i class="fas fa-user-plus text-gray-300 text-lg"></i>
                <span>Add Profile</span>
              </div>
              <div class="profile-dropdown-item" onclick="alert('Guest profile coming soon')">
                <i class="fas fa-user-secret text-gray-300 text-lg"></i>
                <span>Open guest profile</span>
              </div>
            </div>
            <div class="profile-dropdown-section" style="border-bottom: none;">
              <div class="profile-dropdown-item" id="dropdownLogout">
                <i class="fas fa-sign-out-alt text-red-400 text-lg"></i>
                <span class="text-red-400">Sign out</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
    <div class="mb-6">
      <p class="text-gray-600" id="welcomeText">Loading events...</p>
    </div>

    <!-- Events Grid -->
    <div id="eventsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Events will be loaded dynamically -->
    </div>
  </main>
</div>

<script>
  // Check authentication
  const token = localStorage.getItem('token');
  const userStr = localStorage.getItem('user');
  
  if (!token || !userStr) {
    window.location.href = '/login';
  } else {
    const user = JSON.parse(userStr);
    
    // Update user avatar
    document.getElementById('userAvatar').src = user.profile_picture;
    document.getElementById('welcomeText').textContent = `Browse all upcoming events for ${user.name}`;
    
    // Fetch events from API
    fetch('/api/events')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderEvents(data.events);
        } else {
          console.error('Failed to load events');
        }
      })
      .catch(err => console.error('Error fetching events:', err));

    function renderEvents(events) {
      const container = document.getElementById('eventsContainer');
      container.innerHTML = ''; // Clear loading state if any

      if (events.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No upcoming events found.</p>';
        return;
      }

      events.forEach(event => {
        // Format date
        const dateObj = new Date(event.date);
        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

        const eventCard = `
          <div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition cursor-pointer" onclick="window.location.href='event_register.html?event=${event.id}'">
            <img src="${event.image_url || 'https://via.placeholder.com/500x300?text=Event'}" alt="${event.title}" class="w-full h-48 object-cover">
            <div class="p-4">
              <h3 class="font-bold text-gray-900 text-lg mb-2">${event.title}</h3>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${event.description || ''}</p>
              <div class="space-y-2">
                <div class="flex items-center text-sm text-gray-500">
                  <i class="far fa-calendar mr-2"></i>
                  <span>${dateStr}</span>
                </div>
                <div class="flex items-center text-sm text-gray-500">
                  <i class="far fa-clock mr-2"></i>
                  <span>${timeStr}</span>
                </div>
                <div class="flex items-center text-sm text-gray-500">
                  <i class="fas fa-map-marker-alt mr-2"></i>
                  <span>${event.location || 'TBD'}</span>
                </div>
              </div>
              <button class="mt-4 w-full bg-iomp-blue-light text-white py-2 rounded-lg hover:bg-iomp-blue-dark transition">
                Register
              </button>
            </div>
          </div>
        `;
        container.innerHTML += eventCard;
      });
    }
    
    // Profile Dropdown Functionality
    const userAvatar = document.getElementById('userAvatar');
    const profileDropdown = document.getElementById('profileDropdown');
    const dropdownLogout = document.getElementById('dropdownLogout');
    
    // Toggle dropdown on avatar click
    userAvatar.addEventListener('click', (e) => {
      e.stopPropagation();
      profileDropdown.classList.toggle('active');
      
      // Populate dropdown with user data
      document.getElementById('dropdownAvatar').src = user.profile_picture;
      document.getElementById('dropdownName').textContent = user.name || 'User';
      document.getElementById('dropdownEmail').textContent = user.email || 'user@email.com';
      
      // Load other profiles
      loadOtherProfiles(user);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!profileDropdown.contains(e.target) && e.target !== userAvatar) {
        profileDropdown.classList.remove('active');
      }
    });
    
    // Logout from dropdown
    dropdownLogout.addEventListener('click', () => {
      if (confirm('Are you sure you want to sign out?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('lastLoginTime');
        window.location.href = '/login';
      }
    });
    
    // Load other profiles (simulated)
    function loadOtherProfiles(currentUser) {
      const otherProfilesList = document.getElementById('otherProfilesList');
      
      const otherProfiles = [
        { name: 'Admin Profile', email: 'admin@techvista.edu', avatar: 'https://ui-avatars.com/api/?name=Admin&background=ef4444&color=fff' },
        { name: 'Staff Account', email: 'staff@techvista.edu', avatar: 'https://ui-avatars.com/api/?name=Staff&background=3b82f6&color=fff' }
      ].filter(profile => profile.email !== currentUser.email);
      
      otherProfilesList.innerHTML = otherProfiles.map(profile => `
        <div class="profile-dropdown-item" onclick="switchProfile('${profile.email}')">
          <img src="${profile.avatar}" class="w-8 h-8 rounded-full" alt="${profile.name}">
          <div class="flex-1">
            <div class="text-sm font-medium">${profile.name}</div>
            <div class="text-xs text-gray-400">${profile.email}</div>
          </div>
        </div>
      `).join('');
    }
    
    // Switch profile function
    window.switchProfile = function(email) {
      alert(`Profile switching coming soon! Selected: ${email}`);
    };
  }
</script>
<script src="chatbot_widget.js"></script>
</body>
</html>
